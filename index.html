<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ–éŸ³60å¸§æ‹¯æ•‘ç¥å™¨ | @ç”µå­é¸½</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        :root {
            --bg-body: #0a0a0c;
            --bg-card: #18181b;
            --bg-input: #27272a;
            --primary: #fe2c55; /* æŠ–éŸ³çº¢ */
            --primary-hover: #ea294d;
            --cyan: #25f4ee;    /* æŠ–éŸ³è“ */
            --text-main: #f1f5f9;
            --text-sub: #9ca3af;
            --border-radius: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 30px 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .app-container {
            width: 100%;
            max-width: 540px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* --- ä½œè€…åç‰‡åŒº --- */
        .profile-card {
            display: flex;
            align-items: center;
            background: linear-gradient(145deg, #1e1e24, #18181b);
            padding: 16px;
            border-radius: 20px;
            border: 1px solid #2d2d30;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            gap: 15px;
        }
        .avatar-wrapper {
            position: relative;
            width: 60px;
            height: 60px;
        }
        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
            padding: 2px;
            background: #fff;
        }
        .info { flex: 1; }
        .name { font-size: 18px; font-weight: bold; color: #fff; display: flex; align-items: center; gap: 6px; }
        .verified { color: var(--cyan); font-size: 14px; }
        .bio { font-size: 12px; color: #888; margin-top: 4px; line-height: 1.4; }
        
        .btn-follow {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s;
        }
        .btn-follow:hover { transform: scale(1.05); background: var(--primary-hover); }

        /* --- é¡¶éƒ¨ç¢ç¢å¿µ --- */
        .chat-bubble {
            background: rgba(37, 244, 238, 0.08);
            border: 1px solid rgba(37, 244, 238, 0.15);
            color: #8bece8;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
            position: relative;
        }

        /* --- ä¸»åŠŸèƒ½å¡ç‰‡ --- */
        .card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid #2d2d30;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
            transition: 0.3s ease;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 700; color: #fff; }
        
        /* æŒ‰é’® */
        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(254, 44, 85, 0.25); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { background: var(--bg-input); color: #fff; border: 1px solid #3f3f46; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); box-shadow: none; }

        .btn-reset { background: transparent; color: #666; font-size: 12px; border: none; cursor: pointer; }
        .btn-reset:hover { color: var(--danger); text-decoration: underline; }

        /* è¿›åº¦æ¡ */
        .progress-box { margin-top: 15px; background: #000; height: 5px; border-radius: 3px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; width: 0%; transition: width 0.3s ease; }
        .bg-cyan { background: var(--cyan); }
        .bg-red { background: var(--primary); }
        .status-text { font-size: 12px; color: #666; margin-top: 8px; text-align: center; }

        .disabled-card { opacity: 0.3; pointer-events: none; filter: blur(0.5px); }
        .active-card { border: 1px solid rgba(254, 44, 85, 0.4); }

        /* æŠ˜å åŒº */
        .faq-box { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .faq-item { background: #121214; border-radius: 10px; overflow: hidden; border: 1px solid #222; }
        .faq-head { padding: 14px 16px; font-size: 14px; font-weight: 500; cursor: pointer; color: #d1d5db; display: flex; justify-content: space-between; }
        .faq-head:hover { background: #1c1c1f; }
        .faq-body { display: none; padding: 0 16px 16px; font-size: 13px; color: #9ca3af; line-height: 1.6; border-top: 1px solid #222; }
        .faq-item.open .faq-body { display: block; }

        /* éšè—æ—¥å¿— */
        #log-area { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    
    <div class="profile-card">
        <div class="avatar-wrapper">
            <img src="https://p3-pc.douyinpic.com/img/aweme-avatar/tos-cn-i-0813_o8AASQAPefOAsyckGmIlELvB7BwGMAYaQIeC5P~c5_300x300.jpeg?from=2956013662" alt="ç”µå­é¸½" class="avatar">
        </div>
        <div class="info">
            <div class="name">ç”µå­é¸½ <span class="verified">âš¡</span></div>
            <div class="bio">ä¿æŒç‹¬ç«‹æ€è€ƒï¼Œåšç‚¹è‡ªå·±æƒ³åšçš„äº‹<br>è°¢è°¢ä½ çš„å…³æ³¨ï¼Œæœ‰é—®é¢˜å¯ä»¥ç§ä¿¡æˆ‘</div>
        </div>
        <a href="https://v.douyin.com/lDP6mABJqsE/" target="_blank" class="btn-follow">å…³æ³¨</a>
    </div>

    <div class="chat-bubble">
        ğŸ¤« <b>ç¢ç¢å¿µï¼š</b>å¤§å®¶æ”¾å¿ƒç”¨ï¼Œè¿™ä¸ªå·¥å…·æ˜¯çº¯æœ¬åœ°è¿è¡Œçš„ï¼Œè§†é¢‘å°±åœ¨ä½ è‡ªå·±ç”µè„‘é‡Œè½¬åœˆåœˆï¼Œ<b>ç»å¯¹ä¸ä¼š</b>ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå®‰å…¨å¾—å¾ˆï¼
    </div>

    <div class="card active-card" id="card-init">
        <div class="card-header">
            <div class="card-title">1ï¸âƒ£ å‡†å¤‡å·¥ä½œ</div>
            <button class="btn-reset" onclick="resetEngine()">å·¥å…·å¡ä½äº†ï¼Ÿç‚¹æˆ‘é‡ç½®</button>
        </div>
        
        <p style="font-size: 13px; color: #777; margin: 0 0 16px 0;">
            ç¬¬ä¸€æ¬¡ç”¨éœ€è¦åŠ è½½ä¸€ä¸ªå¤§çº¦ 25MB çš„ç»„ä»¶ï¼Œä¼šè‡ªåŠ¨å­˜åˆ°æµè§ˆå™¨ç¼“å­˜é‡Œã€‚ä¸‹æ¬¡æ‰“å¼€å°±ç§’åŠ è½½äº†~
        </p>

        <button id="btn-init" class="btn btn-primary" onclick="initEngine()">
            <span>âš¡ ç‚¹å‡»åŠ è½½å·¥å…·</span>
        </button>
        
        <div class="progress-box" id="track-engine">
            <div class="progress-bar bg-cyan" id="fill-engine"></div>
        </div>
        <div id="label-engine" class="status-text">ç­‰å¾…ç‚¹å‡»...</div>
    </div>

    <div class="card disabled-card" id="card-process">
        <div class="card-header">
            <div class="card-title">2ï¸âƒ£ ä¸Šä¼ è§†é¢‘</div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 16px;">
            <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()">
                ğŸ“‚ ä¸Šä¼ 60å¸§è§†é¢‘
            </button>
            <input type="file" id="file-input" hidden accept="video/mp4,video/mov">
        </div>
        
        <div id="file-info" style="font-size: 12px; color: #555; margin-bottom: 16px; padding-left: 5px;">
            æ”¯æŒ MP4 / MOV æ ¼å¼ (å»ºè®®ç”¨ 60å¸§ çš„ç´ æ)
        </div>

        <button id="btn-start" class="btn btn-primary" onclick="startFix()" disabled>
            <span>âœ¨ ä¸€é”®å¯¼å‡º</span>
        </button>

        <div class="progress-box" id="track-process">
            <div class="progress-bar bg-red" id="fill-process"></div>
        </div>
        <div id="label-process" class="status-text">ç­‰ç€å¹²æ´»...</div>
    </div>

    <div class="faq-box">
        <div class="faq-item open">
            <div class="faq-head" onclick="toggleAcc(this)">ğŸ“– æ€ä¹ˆç”¨ï¼Ÿ</div>
            <div class="faq-body" style="padding-top: 12px;">
                å¾ˆç®€å•ï¼š<br>
                1. ç‚¹ä¸Šé¢çš„<b>â€œåŠ è½½å·¥å…·â€</b>ï¼ˆå°±ç¬¬1æ¬¡éœ€è¦ç‚¹ï¼‰ã€‚<br>
                2. é€‰ä½ å½•å¥½çš„ 60å¸§ è§†é¢‘ã€‚<br>
                3. ç­‰å®ƒè·‘å®Œï¼Œä¼šè‡ªåŠ¨ä¸‹è½½ä¸€ä¸ªå¸¦ <code>[DY60]</code> å‰ç¼€çš„æ–°è§†é¢‘ã€‚<br>
                4. æŠŠæ–°è§†é¢‘ä¸Šä¼ æŠ–éŸ³å°±å®Œäº‹äº†ï¼
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-head" onclick="toggleAcc(this)">â“ å‡ ä¸ªå¸¸è§è¯¯åŒº (å¿…çœ‹)</div>
            <div class="faq-body" style="padding-top: 12px;">
                <strong>Qï¼šä¸ºå•¥ç”µè„‘ä¸Šæ’­æ”¾æ˜¯èŠ±å±æˆ–è€…æ…¢åŠ¨ä½œï¼Ÿ</strong><br>
                Aï¼šæ­£å¸¸ç°è±¡ï¼åˆ«æ…Œã€‚å› ä¸ºæ”¹äº†åº•å±‚æ—¶é—´æˆ³å»éª—è¿‡æŠ–éŸ³çš„ç®—æ³•ï¼Œæœ¬åœ°æ’­æ”¾å™¨ä¼šæ‡µåœˆï¼Œä½†ä½ <b>ä¸Šä¼ åˆ°æŠ–éŸ³ä¹‹åå°±æ˜¯æ­£å¸¸çš„ 60 å¸§äº†</b>ã€‚<br><br>
                
                <strong>Qï¼šä¸Šä¼ åè¿˜æ˜¯ä¸æµç•…ï¼Ÿ</strong><br>
                Aï¼šæŠ–éŸ³æœåŠ¡å™¨è½¬ç éœ€è¦ä¸€ç‚¹æ—¶é—´ï¼ˆå¤§æ¦‚åŠå°æ—¶ï¼‰ï¼Œæˆ–è€…æ¢ä¸ªå°å·çœ‹çœ‹ï¼Œæœ‰æ—¶å€™æ˜¯ç¼“å­˜é”…ã€‚<br><br>

                <strong>Qï¼šç‚¹ä¸åŠ¨/æ²¡ååº”ï¼Ÿ</strong><br>
                Aï¼šç‚¹ä¸€ä¸‹ç¬¬1æ­¥å³ä¸Šè§’çš„â€œå·¥å…·å¡ä½äº†â€ï¼Œæˆ–è€…åˆ·æ–°é¡µé¢é‡æ¥ã€‚
            </div>
        </div>
    </div>
</div>

<div id="log-area"></div>

<script>
    // ================= 7ED CDN åŠ é€Ÿé…ç½® =================
    const CDN_BASE = 'https://use.sevencdn.com/ajax/libs/ffmpeg-core/0.11.0/';
    const URL_JS   = 'https://use.sevencdn.com/ajax/libs/ffmpeg/0.11.0/ffmpeg.min.js';
    const CORE_URL = CDN_BASE + 'ffmpeg-core.js';
    const WASM_URL = CDN_BASE + 'ffmpeg-core.wasm';
    const WORK_URL = CDN_BASE + 'ffmpeg-core.worker.js';
    // ====================================================

    let ffmpeg = null;
    let selectedFile = null;

    const $ = id => document.getElementById(id);
    
    // æŠ˜å èœå•é€»è¾‘
    function toggleAcc(header) {
        header.parentElement.classList.toggle('open');
    }

    // ç¯å¢ƒæ£€æµ‹
    window.onload = () => {
        if (!window.crossOriginIsolated) {
            $('btn-init').innerText = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒ (éœ€å¼€å¯è·¨åŸŸéš”ç¦»)';
            $('btn-init').disabled = true;
            alert("å“å‘€ï¼Œç¯å¢ƒæ£€æµ‹æ²¡é€šè¿‡ï¼\nè¯·ç¡®ä¿ co-serviceworker.js å·²ç»åœ¨ç›®å½•é‡Œï¼Œå¹¶ä¸”ä¸è¦ç›´æ¥åŒå‡» html æ‰“å¼€ï¼Œè¦ç”¨æœåŠ¡è¿è¡Œã€‚");
        }
    };

    // é‡ç½®é€»è¾‘
    async function resetEngine() {
        if(!confirm('ç¡®å®šè¦é‡ç½®å—ï¼Ÿ\nå¦‚æœä¸‹è½½å¡ä½æˆ–è€…æŠ¥é”™ï¼Œé‡ç½®ä¸€ä¸‹é€šå¸¸å°±å¥½äº†ã€‚')) return;
        try {
            const dbs = await window.indexedDB.databases();
            dbs.forEach(db => {
                if(db.name.includes('ffmpeg')) window.indexedDB.deleteDatabase(db.name);
            });
        } catch(e) {}
        location.reload();
    }

    // åˆå§‹åŒ–å¼•æ“
    async function initEngine() {
        if (ffmpeg) return;

        const btn = $('btn-init');
        btn.disabled = true;
        $('track-engine').style.display = 'block';
        $('label-engine').innerText = 'æ­£åœ¨è¿æ¥èµ„æº...';
        
        try {
            // 1. åŠ è½½ JS
            if (!window.FFmpeg) await loadScript(URL_JS);

            // 2. ä¸‹è½½æ ¸å¿ƒ (å¸¦è¿›åº¦)
            const response = await fetch(WASM_URL);
            if (!response.ok) throw new Error(`ç½‘ç»œä¸è¡Œ: ${response.status}`);

            const reader = response.body.getReader();
            const total = +response.headers.get('content-length');
            let loaded = 0;
            let chunks = [];

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
                loaded += value.length;
                if (total) {
                    const percent = Math.round((loaded / total) * 100);
                    $('fill-engine').style.width = `${percent}%`;
                    $('label-engine').innerText = `æ­£åœ¨ä¸‹è½½ç»„ä»¶ ${percent}%`;
                }
            }

            const wasmBlob = new Blob(chunks, { type: 'application/wasm' });
            const wasmBlobUrl = URL.createObjectURL(wasmBlob);
            $('label-engine').innerText = 'æ­£åœ¨ç»„è£…å¼•æ“...';

            // 3. å¯åŠ¨
            const { createFFmpeg } = FFmpeg;
            ffmpeg = createFFmpeg({
                log: false, 
                corePath: CORE_URL,
                workerPath: WORK_URL,
                wasmPath: wasmBlobUrl
            });

            await ffmpeg.load();
            
            btn.innerHTML = '<span>âœ… å·¥å…·åŠ è½½å¥½äº†</span>';
            btn.style.background = '#10b981'; 
            $('label-engine').innerText = 'å°±ç»ª';
            $('card-process').classList.remove('disabled-card');
            $('card-process').classList.add('active-card');
            $('card-init').classList.remove('active-card');

        } catch (e) {
            console.error(e);
            btn.disabled = false;
            btn.innerText = 'âš ï¸ åŠ è½½å¤±è´¥ (ç‚¹æˆ‘é‡è¯•)';
            $('label-engine').innerText = 'å‡ºäº†ç‚¹å°é—®é¢˜';
            alert('åŠ è½½å¤±è´¥äº†ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è€…ç‚¹å³ä¸Šè§’é‡ç½®è¯•è¯•ã€‚');
        }
    }

    // é€‰æ–‡ä»¶
    $('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            selectedFile = file;
            $('file-info').innerHTML = `ğŸ“„ <span style="color:#fff;">${file.name}</span> <span style="color:#777;">(${(file.size/1024/1024).toFixed(1)} MB)</span>`;
            
            $('btn-start').disabled = false;
            $('btn-start').innerHTML = '<span>âœ¨ ä¸€é”®ä¿®å¤æ—¶é—´æˆ³</span>';
            $('fill-process').style.width = '0%';
            $('label-process').innerText = 'å‡†å¤‡å°±ç»ª';
        }
    });

    // å¼€å§‹å¹²æ´»
    async function startFix() {
        if (!selectedFile || !ffmpeg) return;

        $('btn-start').disabled = true;
        $('file-input').disabled = true;
        $('track-process').style.display = 'block';

        try {
            const { fetchFile } = FFmpeg;
            const inputName = 'input.mp4';
            const outputName = 'output.mp4';

            ffmpeg.setProgress(({ ratio }) => {
                const percent = (ratio * 100).toFixed(1);
                if(percent >= 0 && percent <= 100) {
                    $('fill-process').style.width = `${percent}%`;
                    $('label-process').innerText = `æ­£åœ¨å¤„ç† ${percent}%`;
                }
            });

            // å†™å…¥
            ffmpeg.FS('writeFile', inputName, await fetchFile(selectedFile));

            // è·‘å‘½ä»¤
            await ffmpeg.run('-itsscale', '2', '-i', inputName, '-c', 'copy', outputName);

            // å¯¼å‡º
            const data = ffmpeg.FS('readFile', outputName);
            const newFileName = `[DY60]${selectedFile.name}`;
            
            const blob = new Blob([data.buffer], { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = newFileName;
            a.click();

            $('label-process').innerText = 'æå®šï¼';
            $('btn-start').innerText = 'ğŸ‰ å¤„ç†å®Œäº†ï¼Œæä¸‹ä¸€ä¸ª';

            ffmpeg.FS('unlink', inputName);
            ffmpeg.FS('unlink', outputName);
            URL.revokeObjectURL(url);

        } catch (e) {
            console.error(e);
            $('label-process').innerText = 'æŠ¥é”™äº†';
            $('btn-start').innerText = 'âš ï¸ é‡è¯•';
            alert('å¤„ç†çš„æ—¶å€™å‡ºé”™äº†ï¼Œè¦æ˜¯è¿˜æ²¡å¥½ï¼Œå°±ç‚¹ä¸Šé¢çš„é‡ç½®æŒ‰é’®ã€‚');
        }

        $('btn-start').disabled = false;
        $('file-input').disabled = false;
        $('file-input').value = ''; 
        selectedFile = null; 
    }

    function loadScript(url) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }
</script>
</body>
</html>