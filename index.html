<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ–éŸ³60å¸§ä¿®å¤å·¥å…· (å¤šæºè‡ªåŠ¨åˆ‡æ¢ç‰ˆ)</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.zhimg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <style>
        :root { --primary: #fe2c55; --bg: #f0f2f5; --card: #fff; --text: #161823; --sub: #8a8b91; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; color: var(--text); }
        .container { background: var(--card); width: 90%; max-width: 480px; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        h1 { margin: 0 0 10px 0; font-size: 24px; }
        .subtitle { color: var(--sub); margin-bottom: 20px; font-size: 14px; }
        
        /* åˆå§‹åŒ–åŒºåŸŸ */
        #init-area { padding: 20px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(254, 44, 85, 0.3); }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* è¿›åº¦æ¡ */
        .progress-container { margin-top: 20px; display: none; }
        progress { width: 100%; height: 10px; border-radius: 5px; overflow: hidden; }
        progress::-webkit-progress-bar { background-color: #eee; }
        progress::-webkit-progress-value { background-color: var(--primary); transition: width 0.3s; }
        .progress-text { font-size: 12px; color: var(--sub); margin-top: 5px; display: block; }

        /* åŠŸèƒ½åŒºåŸŸ (åˆå§‹éšè—) */
        #app-area { display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .upload-box { border: 2px dashed #e0e0e0; border-radius: 12px; padding: 40px 20px; cursor: pointer; background: #fafafa; margin-bottom: 20px; }
        .upload-box:hover { border-color: var(--primary); background: #fff0f3; }
        .upload-icon { font-size: 40px; display: block; margin-bottom: 10px; }
        
        #log { font-size: 12px; color: #999; margin-top: 10px; white-space: pre-wrap; height: 30px; }
        .tag { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-family: monospace; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸµ æŠ–éŸ³60å¸§ä¿®å¤åŠ©æ‰‹</h1>
        <p class="subtitle">æ™ºèƒ½å¤šæºåŠ é€Ÿ | <span class="tag">-itsscale 2</span></p>

        <div id="init-area">
            <button id="initBtn" class="btn-main" onclick="startInitialization()">ğŸš€ ç‚¹å‡»åŠ è½½å¼•æ“</button>
            <div class="progress-container" id="progressBox">
                <progress id="progressBar" value="0" max="100"></progress>
                <span id="progressText" class="progress-text">å‡†å¤‡è¿æ¥...</span>
            </div>
            <div id="errorLog" style="color: red; font-size: 12px; margin-top: 10px;"></div>
        </div>

        <div id="app-area">
            <div class="upload-box" onclick="document.getElementById('uploader').click()">
                <span class="upload-icon">ğŸ“‚</span>
                <div>ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘åˆ°è¿™é‡Œ</div>
                <div style="font-size: 12px; color: #999; margin-top: 5px">æ”¯æŒ MP4, MOV</div>
            </div>
            <input type="file" id="uploader" accept="video/*">
            
            <div id="status-text" style="font-weight: 500;">å‡†å¤‡å°±ç»ª</div>
            <div id="log"></div>
            <button id="downloadBtn" class="btn-main" style="display: none; margin-top: 15px;">ä¸‹è½½ç»“æœ</button>
        </div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        let ffmpeg = null;

        // ================= é…ç½®åŒºåŸŸ =================
        // ä½ çš„ GitHub ä»“åº“æ–‡ä»¶åœ°å€ (Blob è·¯å¾„)
        const REPO_PATH = 'https://github.com/wwwqqq001/DY60/blob/main/';
        
        // å¤‡ç”¨é•œåƒåˆ—è¡¨ (ä¼˜å…ˆçº§ä»ä¸Šåˆ°ä¸‹)
        const MIRROR_LIST = [
            'https://hub.gitmirror.com/',  // é•œåƒ1
            'https://ghps.cc/',            // é•œåƒ2
            'https://ghproxy.com/',        // é•œåƒ3
            'https://cors.isteed.cc/'      // é•œåƒ4
        ];
        // ===========================================

        // UI å¼•ç”¨
        const initBtn = document.getElementById('initBtn');
        const progressBox = document.getElementById('progressBox');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const initArea = document.getElementById('init-area');
        const appArea = document.getElementById('app-area');
        const errorLog = document.getElementById('errorLog');

        // å¸¦æœ‰è¿›åº¦çš„ä¸‹è½½å‡½æ•°
        async function fetchWithProgress(url, name) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const reader = response.body.getReader();
            const contentLength = +response.headers.get('Content-Length');
            let receivedLength = 0;
            let chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                receivedLength += value.length;
                
                // åªæœ‰ä¸‹è½½å¤§æ–‡ä»¶(wasm)æ—¶æ‰æ›´æ–°è¿›åº¦æ¡
                if (name === 'wasm' && contentLength) {
                    const percent = Math.round((receivedLength / contentLength) * 100);
                    progressBar.value = percent;
                    progressText.innerText = `æ­£åœ¨ä¸‹è½½å¼•æ“ (${percent}%) - ${url.substring(0, 25)}...`;
                }
            }

            const blob = new Blob(chunks);
            return URL.createObjectURL(blob);
        }

        // æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘
        async function startInitialization() {
            initBtn.disabled = true;
            initBtn.style.display = 'none';
            progressBox.style.display = 'block';
            errorLog.innerText = '';

            let success = false;

            // å¾ªç¯å°è¯•æ¯ä¸€ä¸ªé•œåƒ
            for (let i = 0; i < MIRROR_LIST.length; i++) {
                const mirror = MIRROR_LIST[i];
                const coreUrl   = mirror + REPO_PATH + 'ffmpeg-core.js';
                const workerUrl = mirror + REPO_PATH + 'ffmpeg-core.worker.js';
                const wasmUrl   = mirror + REPO_PATH + 'ffmpeg-core.wasm';

                try {
                    progressText.innerText = `æ­£åœ¨å°è¯•çº¿è·¯ ${i + 1}/${MIRROR_LIST.length}...`;
                    progressBar.value = 5; // åˆšå¼€å§‹ç»™ä¸€ç‚¹è¿›åº¦

                    // 1. å¹¶è¡Œä¸‹è½½è¿™ä¸‰ä¸ªæ–‡ä»¶ (å…³é”®ï¼šwasm ä¼šè§¦å‘è¿›åº¦æ¡)
                    // ä½¿ç”¨ Promise.all åŒæ—¶å‘èµ·è¯·æ±‚ï¼Œé€Ÿåº¦æ›´å¿«
                    const [coreBlob, workerBlob, wasmBlob] = await Promise.all([
                        fetchWithProgress(coreUrl, 'core'),
                        fetchWithProgress(workerUrl, 'worker'),
                        fetchWithProgress(wasmUrl, 'wasm') // è¿™ä¸ªæœ€å¤§ï¼Œè´Ÿè´£é©±åŠ¨è¿›åº¦æ¡
                    ]);

                    progressText.innerText = 'ä¸‹è½½å®Œæˆï¼Œæ­£åœ¨ç¼–è¯‘å¼•æ“...';
                    progressBar.removeAttribute('value'); // å˜æˆä¸ç¡®å®šè¿›åº¦çš„æ»šåŠ¨æ¡

                    // 2. ä½¿ç”¨ä¸‹è½½å¥½çš„ Blob åˆå§‹åŒ– FFmpeg
                    ffmpeg = createFFmpeg({
                        log: true,
                        corePath: coreBlob,
                        workerPath: workerBlob,
                        wasmPath: wasmBlob
                    });

                    await ffmpeg.load();
                    success = true;
                    break; // æˆåŠŸäº†ï¼Œè·³å‡ºå¾ªç¯

                } catch (err) {
                    console.error(`çº¿è·¯ ${i+1} å¤±è´¥:`, err);
                    errorLog.innerText += `çº¿è·¯ ${i+1} è¿æ¥è¶…æ—¶/å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢...\n`;
                    // ç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå°è¯•ä¸‹ä¸€ä¸ªé•œåƒ
                }
            }

            if (success) {
                // åˆ‡æ¢ç•Œé¢
                initArea.style.display = 'none';
                appArea.style.display = 'block';
            } else {
                initBtn.disabled = false;
                initBtn.style.display = 'inline-block';
                initBtn.innerText = 'é‡è¯• (æ‰€æœ‰çº¿è·¯å‡å¤±è´¥)';
                progressBox.style.display = 'none';
                alert('æ‰€æœ‰åŠ é€Ÿé•œåƒéƒ½æ— æ³•è¿æ¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚');
            }
        }

        // --- ä¸‹é¢æ˜¯ä¹‹å‰çš„è§†é¢‘å¤„ç†é€»è¾‘ (ä¿æŒä¸å˜) ---
        
        const uploader = document.getElementById('uploader');
        const statusText = document.getElementById('status-text');
        const logDiv = document.getElementById('log');
        const downloadBtn = document.getElementById('downloadBtn');

        const transcode = async ({ target: { files } }) => {
            const file = files[0];
            if (!file) return;

            downloadBtn.style.display = 'none';
            statusText.innerText = 'æ­£åœ¨å¤„ç†è§†é¢‘...';
            logDiv.innerText = 'å†™å…¥å†…å­˜ä¸­...';

            try {
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));
                
                // è¾“å‡ºæ—¥å¿—åˆ°ç•Œé¢
                ffmpeg.setLogger(({ message }) => {
                    console.log(message);
                    if(message.includes('time=')) logDiv.innerText = "å¤„ç†è¿›åº¦: " + message.match(/time=\S+/)[0];
                });

                await ffmpeg.run('-itsscale', '2', '-i', 'input.mp4', '-c', 'copy', 'output.mp4');

                statusText.innerText = 'å¤„ç†å®Œæˆï¼';
                logDiv.innerText = 'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½';
                
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));

                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `[DY60]${file.name}`;
                    a.click();
                };
                downloadBtn.style.display = 'inline-block';
                
                try { ffmpeg.FS('unlink', 'input.mp4'); ffmpeg.FS('unlink', 'output.mp4'); } catch(e){}

            } catch (err) {
                console.error(err);
                statusText.innerText = 'å¤„ç†å‡ºé”™';
                logDiv.innerText = err.message;
            }
        };

        uploader.addEventListener('change', transcode);
    </script>
</body>
</html>
