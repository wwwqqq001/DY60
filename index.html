<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>视频处理工具 (Douyin 60)</title>
    <script src="coi-serviceworker.js"></script>
    <script src="ffmpeg.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .container { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 20px; }
        #status { margin-top: 15px; color: #333; font-weight: bold; white-space: pre-wrap; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; display: none; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>视频处理工具 (本地离线版)</h2>
    <p>功能：执行 <code>-itsscale 2</code> (修复时间戳/慢放)，完全本地运行。</p>
    
    <div class="container">
        <input type="file" id="uploader" accept="video/*">
        <div id="status">请选择视频文件...</div>
        <button id="downloadBtn">下载处理后的视频</button>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        
        // 3. 配置 FFmpeg 使用本地的核心文件
        const ffmpeg = createFFmpeg({ 
            log: true,
            corePath: './ffmpeg-core.js' // 关键修改：强制指向本地文件
        });

        const transcode = async ({ target: { files } }) => {
            const status = document.getElementById('status');
            const btn = document.getElementById('downloadBtn');
            const file = files[0];
            
            if (!file) return;

            status.innerText = '正在加载核心文件 (首次运行需要加载 25MB 文件，请耐心等待)...';
            btn.style.display = 'none';

            try {
                if (!ffmpeg.isLoaded()) {
                    await ffmpeg.load();
                }

                status.innerText = '正在处理: ' + file.name + ' ...\n请不要关闭页面';

                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));

                await ffmpeg.run(
                    '-itsscale', '2', 
                    '-i', 'input.mp4', 
                    '-c:v', 'copy', 
                    '-c:a', 'copy', 
                    'output.mp4'
                );

                status.innerText = '处理完成！正在准备下载...';

                const data = ffmpeg.FS('readFile', 'output.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                
                btn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `[60]${file.name.split('.')[0]}.mp4`;
                    a.click();
                };
                btn.style.display = 'inline-block';
                status.innerText = '处理成功！点击下方按钮下载。';
                
            } catch (error) {
                console.error(error);
                status.innerText = '出错了！\n请检查控制台(F12)日志。\n常见原因：GitHub Pages 更新延迟，请等待 1-2 分钟后刷新重试。';
            }
        };

        document.getElementById('uploader').addEventListener('change', transcode);
    </script>
</body>
</html>
