<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>视频处理工具 (Douyin 60)</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .container { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 20px; }
        #status { margin-top: 15px; color: #333; font-weight: bold; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; display: none; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>视频处理工具 (Web版)</h2>
    <p>功能：执行 <code>-itsscale 2</code> (通常用于慢放或修复时间戳)，并不转码直接导出。</p>
    
    <div class="container">
        <input type="file" id="uploader" accept="video/*">
        <div id="status">请选择视频文件...</div>
        <button id="downloadBtn">下载处理后的视频</button>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        // 创建 FFmpeg 实例，显示日志以便调试
        const ffmpeg = createFFmpeg({ log: true });

        const transcode = async ({ target: { files } }) => {
            const status = document.getElementById('status');
            const btn = document.getElementById('downloadBtn');
            const file = files[0];
            
            if (!file) return;

            status.innerText = '正在加载 FFmpeg (首次运行可能较慢)...';
            btn.style.display = 'none';

            if (!ffmpeg.isLoaded()) {
                await ffmpeg.load();
            }

            status.innerText = '正在处理: ' + file.name + ' ...';

            // 1. 把文件写入 FFmpeg 的虚拟内存
            ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));

            // 2. 执行你的命令: ffmpeg -itsscale 2 -i input -c:v copy -c:a copy output
            // 注意：Web版为了兼容性，通常强制输出为 mp4
            try {
                await ffmpeg.run(
                    '-itsscale', '2', 
                    '-i', 'input.mp4', 
                    '-c:v', 'copy', 
                    '-c:a', 'copy', 
                    'output.mp4'
                );

                status.innerText = '处理完成！正在准备下载...';

                // 3. 读取生成的文件
                const data = ffmpeg.FS('readFile', 'output.mp4');

                // 4. 创建下载链接
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                
                btn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `[60]${file.name.split('.')[0]}.mp4`;
                    a.click();
                };
                btn.style.display = 'inline-block';
                status.innerText = '处理成功！点击下方按钮下载。';
                
            } catch (error) {
                console.error(error);
                status.innerText = '出错了，请查看控制台日志 (F12)。';
            }
        };

        document.getElementById('uploader').addEventListener('change', transcode);
    </script>
</body>
</html>